{"file":"la-decorate-internal-refs.js","mappings":"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","names":[],"sources":["src/components/decorate-internal-refs/decorate-internal-refs.scss?tag=la-decorate-internal-refs","src/components/decorate-internal-refs/decorate-internal-refs.tsx"],"sourcesContent":["@use \"sass:meta\";\n\n.la-decorate-internal-refs__popup {\n  position: relative;\n  @include meta.load-css(\"~tippy.js/dist/tippy.css\");\n  @include meta.load-css(\"~tippy.js/themes/light-border.css\");\n  @include meta.load-css(\"../../styles/tippy\");\n}\n\nla-akoma-ntoso.flag-internal-refs .akn-ref[href^=\"#\"]::after {\n  display: inline-block;\n  content: \"\";\n  vertical-align: -.125em;\n  background-image: url(\"data:image/svg+xml,<svg viewBox='0 0 16 16' fill='%239c27b0' xmlns='http://www.w3.org/2000/svg'><path d='M2 2v13.5a.5.5 0 0 0 .74.439L8 13.069l5.26 2.87A.5.5 0 0 0 14 15.5V2a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2z'/></svg>\");\n  background-repeat: no-repeat;\n  width: 0.8rem;\n  height: 0.8rem;\n}\n","import { Component, Prop, Element, Watch } from '@stencil/core';\nimport type { Instance as Tippy } from 'tippy.js';\nimport tippy from 'tippy.js';\n\nimport { AkomaNtosoTarget } from '../../utils/linking';\nimport { PROVIDER, getPartner } from '../../utils/services';\n\n/**\n * Remove the existing portion (if any) of frbrUri, and add the new portion to it.\n */\nfunction addPortion(frbrUri: string, portion: string) {\n  const ix = frbrUri.indexOf('~');\n  if (ix > -1) {\n    frbrUri = frbrUri.slice(0, ix);\n  }\n\n  if (!frbrUri.endsWith('/')) frbrUri = frbrUri + '/';\n\n  return frbrUri + portion;\n}\n\n@Component({\n  tag: 'la-decorate-internal-refs',\n  styleUrl: 'decorate-internal-refs.scss',\n})\nexport class DecorateInternalRefs {\n  // The akn content element being decorated\n  protected akomaNtosoElement?: HTMLElement | null;\n\n  protected tippies: Tippy[] = [];\n  protected tippyContainer?: HTMLElement;\n\n  @Element() el!: HTMLElement;\n\n  /**\n   * CSS selector for the la-akoma-ntoso element or HTMLELement that will be decorated. Defaults\n   * to the containing la-akoma-ntoso element, if any, otherwise the first\n   * `la-akoma-ntoso` element on the page.\n   */\n  @Prop() akomaNtoso?: string | HTMLElement;\n\n  /**\n   * If `true`, the content of internal ref targets will be shown as popups.\n   */\n  @Prop() popups = false;\n\n  /**\n   * If `true`, internal refs will be flagged with in icon to be more visible.\n   */\n  @Prop() flag = false;\n\n  /** Fetch content from Laws.Africa services? Requires a Laws.Africa partnership and the frbrExpressionUri property to be set. */\n  @Prop({ reflect: true, mutable: true }) fetch = false;\n  /** Partner code to use when fetching content from Laws.Africa. Defaults to the `location.hostname`. */\n  @Prop({ reflect: true, mutable: true }) partner?: string;\n\n  /** Provider URL for fetching content (advanced usage only). */\n  @Prop() provider = PROVIDER;\n\n  componentWillLoad() {\n    const target = new AkomaNtosoTarget(this.el, this.akomaNtoso, () => {\n      this.componentDidLoad();\n    });\n    this.akomaNtosoElement = target.getElement();\n    this.tippyContainer = document.createElement('div');\n    this.tippyContainer.className = 'la-decorate-internal-refs__popup';\n    document.body.appendChild(this.tippyContainer);\n  }\n\n  componentDidLoad() {\n    this.changeFlag(this.flag);\n    this.changePopups(this.popups);\n  }\n\n  @Watch('flag')\n  changeFlag(flag: boolean) {\n    if (this.akomaNtosoElement) {\n      this.akomaNtosoElement.classList.toggle('flag-internal-refs', flag);\n    }\n  }\n\n  @Watch('popups')\n  changePopups(popups: boolean) {\n    // remove existing popups\n    for (const tippy of this.tippies) {\n      tippy.destroy();\n    }\n    this.tippies = [];\n\n    if (this.akomaNtosoElement && popups) {\n      this.createPopups();\n    }\n  }\n\n  createPopups() {\n    // @ts-ignore\n    this.tippies = tippy('a.akn-ref[href^=\"#\"]', {\n      appendTo: () => this.tippyContainer,\n      allowHTML: true,\n      hideOnClick: true,\n      interactive: true,\n      maxWidth: 450,\n      onTrigger: this.onTrigger.bind(this),\n      theme: 'light-border',\n    });\n  }\n\n  async onTrigger(tippy: Tippy) {\n    if (this.akomaNtosoElement) {\n      const href: string = tippy.reference.getAttribute('href') || '';\n      let html: string | null = '';\n      const provision: HTMLElement | null = this.akomaNtosoElement.querySelector(href);\n\n      if (provision) {\n        html = provision.outerHTML;\n      } else if (this.fetch) {\n        // try fetching it remotely\n        html = await this.fetchContent(href.slice(1));\n      }\n\n      if (html) {\n        tippy.setContent(`\n        <div>\n          <div class=\"tippy-content__body\"><la-akoma-ntoso>${html}</la-akoma-ntoso></div>\n        </div>`);\n      }\n    }\n  }\n\n  async fetchContent(elementId: string) {\n    this.ensurePartner();\n\n    if (this.provider && this.akomaNtosoElement) {\n      const frbrUri = this.akomaNtosoElement.getAttribute('frbr-expression-uri');\n      if (frbrUri) {\n        const url = this.provider + '/p/' + this.partner + '/e/portion' + addPortion(frbrUri, '~' + elementId);\n        try {\n          const resp = await fetch(url);\n          if (resp.ok) {\n            return await resp.text();\n          }\n        } catch (error) {\n          // ignore\n        }\n      }\n    }\n    return null;\n  }\n\n  ensurePartner() {\n    if (!this.partner) {\n      this.partner = getPartner();\n    }\n  }\n}\n"],"version":3}